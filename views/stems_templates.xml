<odoo>
  <data>
    <template id="portal_my_bookings" name="Mis Reservas" page="True">
      <t t-call="portal.layout">
        <t t-set="breadcrumbs" t-value="[('Mis Reservas', '/my/bookings')]"/>
        <div class="container o_portal_wrap">
          <h2>Mis Reservas</h2>
          <t t-if="not bookings"><p>No tienes reservas.</p></t>
          <t t-foreach="bookings" t-as="b">
            <div class="card mb-3">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <strong t-esc="b.appointment_type_id.name"/>
                  <div class="text-muted">Duración: <t t-esc="b.duration"/> min</div>
                  <div class="text-muted" t-if="b.start">Fecha: <t t-esc="b.start"/></div>
                </div>
                <div class="d-flex gap-2">
                  <a t-attf-href="/my/bookings/{{b.id}}/stems" class="btn btn-outline-primary">Subir stems</a>
                  <a t-if="b.meeting_url" t-att-href="b.meeting_url" class="btn btn-primary" target="_blank">Unirme (Meet)</a>
                </div>
              </div>
            </div>
          </t>
        </div>
      </t>
    </template>

    <template id="portal_stems" name="Stems de la Reserva" page="True">
      <t t-call="portal.layout">
        <t t-set="breadcrumbs" t-value="[('Mis Reservas', '/my/bookings'), ('Stems', request.httprequest.path)]"/>
        <div class="container o_portal_wrap">
          <h2>Subir Stems – <t t-esc="booking.appointment_type_id.name"/></h2>
          <p class="text-muted">Prefijo: <t t-esc="folder.prefix if folder else ''"/></p>

          <div id="mbdd-uploader" class="mb-3" t-att-data-max-mb="max_mb" t-att-data-total-mb="max_total_mb" t-att-data-used-mb="total_uploaded_mb">
            <input id="fileInput" type="file" multiple class="form-control"/>
            <div class="form-text">Tamaño máximo por archivo: <t t-esc="max_mb"/> MB · Cuota total: <t t-esc="max_total_mb"/> MB · Usado: <t t-esc="total_uploaded_mb"/> MB</div>
            <button id="uploadBtn" class="btn btn-primary mt-2">Subir</button>
            <div id="uploadLog" class="mt-2 small text-muted"></div>
          </div>

          <h4>Archivos subidos</h4>
          <ul>
            <t t-foreach="keys" t-as="k"><li><t t-esc="k"/></li></t>
          </ul>

          <script>
          (function(){
            const btn = document.getElementById('uploadBtn');
            const input = document.getElementById('fileInput');
            const log = document.getElementById('uploadLog');
            const box = document.getElementById('mbdd-uploader');
            const maxMB = parseInt(box?.dataset?.maxMb || '1024');
            const maxTotal = parseFloat(box?.dataset?.totalMb || '2048');
            const used = parseFloat(box?.dataset?.usedMb || '0');
            if(!btn) return;
            btn.addEventListener('click', async () => {
              const files = Array.from(input.files || []);
              let remaining = (maxTotal - used) * 1024 * 1024;
              for (const f of files){
                if (f.size > maxMB * 1024 * 1024){
                  log.innerText += `\n${f.name}: demasiado grande (>${maxMB}MB)`;
                  continue;
                }
                if (f.size > remaining){
                  log.innerText += `\n${f.name}: supera la cuota total restante`;
                  continue;
                }
                const resp = await fetch(window.location.pathname + '/presign', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({filename: f.name})});
                const data = await resp.json();
                if(data && data.url){
                  const formData = new FormData();
                  Object.entries(data.fields).forEach(([k,v]) => formData.append(k,v));
                  formData.append('file', f);
                  const up = await fetch(data.url, {method:'POST', body: formData});
                  log.innerText += `\n${f.name}: ${up.ok ? 'OK' : 'ERROR'}`;
                  if (up.ok) remaining -= f.size;
                } else {
                  log.innerText += `\n${f.name}: presign ERROR`;
                }
              }
              window.location.reload();
            });
          })();
          </script>
        </div>
      </t>
    </template>
  </data>
</odoo>
